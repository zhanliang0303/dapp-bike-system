<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å»ä¸­å¿ƒåŒ–å–®è»Šç§Ÿè³ƒç³»çµ±</title>

  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"
    crossorigin="anonymous"
    referrerpolicy="no-referrer">
  </script>

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Microsoft JhengHei", sans-serif;
      background: #0b0f14;
      color: #e8eef7;
    }
    .wrap {
      min-height: 100vh;
      display: grid;
      place-items: center;
      padding: 24px;
    }
    .panel {
      max-width: 600px;
      width: 100%;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 16px;
      padding: 32px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.45);
      text-align: center;
    }
    h1 { margin-top: 0; margin-bottom: 8px; color: #fff; }
    .subtitle { color: #8b9bb4; font-size: 14px; margin-bottom: 24px; }
    
    .status-card {
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
      text-align: left;
    }
    .status-item { margin: 8px 0; font-size: 14px; display: flex; justify-content: space-between; }
    .status-label { color: #8b9bb4; }
    .status-value { font-family: monospace; color: #e8eef7; font-weight: bold; }
    
    .bike-display {
      margin: 24px 0;
      padding: 20px;
      background: rgba(120, 180, 255, 0.05);
      border-radius: 50%;
      width: 80px;
      height: 80px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
      border: 2px solid rgba(120, 180, 255, 0.3);
      transition: 0.3s;
    }
    .bike-active { background: rgba(46, 204, 113, 0.2); border-color: #2ecc71; box-shadow: 0 0 20px rgba(46,204,113,0.4); }

    button {
      width: 100%;
      padding: 14px;
      margin: 8px 0;
      border-radius: 10px;
      border: none;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: 0.2s;
    }
    .btn-connect { background: #f6851b; color: white; }
    .btn-register { background: #3498db; color: white; }
    .btn-rent { background: linear-gradient(135deg, #007bff, #0056b3); color: white; }
    .btn-return { background: linear-gradient(135deg, #2ecc71, #27ae60); color: white; }
    
    button:disabled {
      opacity: 0.3;
      cursor: not-allowed;
      filter: grayscale(100%);
    }
    button:active { transform: scale(0.98); }

    .loader { font-size: 12px; color: #f1c40f; margin-top: 10px; min-height: 18px; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="panel">
      <h1>ğŸš² å€å¡Šéˆå–®è»Šç§Ÿè³ƒç³»çµ±</h1>
      <div class="subtitle">åŸºæ–¼æ™ºèƒ½åˆç´„çš„è‡ªå‹•åŒ–æŠ¼é‡‘é€€é‚„æ©Ÿåˆ¶</div>

      <div class="status-card">
        <div class="status-item">
          <span class="status-label">ç›®å‰å¸³è™Ÿ</span>
          <span class="status-value" id="userAddr">æœªé€£æ¥</span>
        </div>
        <div class="status-item">
          <span class="status-label">ç”¨æˆ¶ç‹€æ…‹</span>
          <span class="status-value" id="regStatus">Checking...</span>
        </div>
        <div class="status-item">
          <span class="status-label">ç§Ÿè³ƒè²»ç‡</span>
          <span class="status-value" style="color: #ff7675;">0.001 ETH</span>
        </div>
        <div class="status-item">
          <span class="status-label">æ‰€éœ€æŠ¼é‡‘</span>
          <span class="status-value" style="color: #55efc4;">0.005 ETH (è‡ªå‹•é€€é‚„)</span>
        </div>
      </div>

      <div id="bikeIcon" class="bike-display">ğŸš²</div>
      <div id="bikeStatusText" style="margin-bottom: 20px; font-size: 14px; color: #8b9bb4;">å–®è»Šç‹€æ…‹: è®€å–ä¸­...</div>

      <button id="btnConnect" class="btn-connect" onclick="init()">ğŸ¦Š é€£æ¥éŒ¢åŒ…</button>
      <button id="btnRegister" class="btn-register" onclick="registerUser()" disabled>ğŸ“ è¨»å†Šæœƒå“¡</button>
      <button id="btnRent" class="btn-rent" onclick="rentBike()" disabled>ğŸ”“ ç§Ÿå€Ÿå–®è»Š (0.006 ETH)</button>
      <button id="btnReturn" class="btn-return" onclick="returnBike()" style="display:none;">ğŸ é‚„è»Šä¸¦å–å›æŠ¼é‡‘</button>

      <div class="loader" id="output"></div>
    </div>
  </div>

<script>
  // =============================
  // 1. è¨­å®šå€ (è«‹æ›æˆä½ çš„åˆç´„åœ°å€)
  // =============================
  const contractAddress = "0x802FB54BE053c9e799F6f37F7A4C3529CC22a296"; 

  const abi = [
    "function registerUser() external",
    "function rentBike(uint256 _bikeID) external payable",
    "function returnBike(uint256 _bikeID) external",
    "function users(address) view returns (bool)",
    "function getBikeStatus(uint256 _bikeID) view returns (bool, address)"
  ];

  // =============================
  // 2. å…¨åŸŸè®Šæ•¸
  // =============================
  let provider, signer, contract, currentAccount;

  // =============================
  // 3. åˆå§‹åŒ–åŠŸèƒ½
  // =============================
  async function init() {
    if (!window.ethereum) {
      alert("è«‹å®‰è£ MetaMask æ“´å……å¥—ä»¶");
      return;
    }

    try {
      // é€£æ¥ Provider
      provider = new ethers.providers.Web3Provider(window.ethereum);
      
      // è«‹æ±‚å¸³è™Ÿæ¬Šé™
      await provider.send("eth_requestAccounts", []);
      const network = await provider.getNetwork();

      // æª¢æŸ¥æ˜¯å¦ç‚º Sepolia æ¸¬è©¦ç¶² (Chain ID: 11155111)
      if (network.chainId !== 11155111) {
        alert("âš ï¸ è«‹åˆ‡æ›è‡³ Sepolia æ¸¬è©¦ç¶²è·¯ï¼");
        return;
      }

      signer = provider.getSigner();
      currentAccount = await signer.getAddress();
      
      // åˆå§‹åŒ–åˆç´„
      contract = new ethers.Contract(contractAddress, abi, signer);

      // æ›´æ–°ä»‹é¢
      updateUI_Connected();
      
      // è®€å–éˆä¸Šç‹€æ…‹
      await refreshData();

      // ç›£è½å¸³è™Ÿåˆ‡æ›
      window.ethereum.on('accountsChanged', () => window.location.reload());

    } catch (e) {
      console.error(e);
      document.getElementById("output").innerText = "âŒ é€£ç·šå¤±æ•—: " + e.message;
    }
  }

  function updateUI_Connected() {
    const shortAddr = currentAccount.substring(0, 6) + "..." + currentAccount.substring(38);
    document.getElementById("userAddr").innerText = shortAddr;
    document.getElementById("btnConnect").innerText = "âœ… å·²é€£æ¥";
    document.getElementById("btnConnect").disabled = true;
    document.getElementById("btnConnect").style.opacity = "0.5";
  }

  // =============================
  // 4. è®€å–ç‹€æ…‹é‚è¼¯ (Core Logic)
  // =============================
  async function refreshData() {
    try {
      // 1. æª¢æŸ¥ä½¿ç”¨è€…æ˜¯å¦è¨»å†Š
      const isRegistered = await contract.users(currentAccount);
      document.getElementById("regStatus").innerText = isRegistered ? "âœ… å·²è¨»å†Šæœƒå“¡" : "âŒ æœªè¨»å†Š";
      document.getElementById("regStatus").style.color = isRegistered ? "#2ecc71" : "#e74c3c";

      // 2. æ§åˆ¶æŒ‰éˆ•ç‹€æ…‹
      if (!isRegistered) {
        document.getElementById("btnRegister").disabled = false;
        document.getElementById("btnRent").disabled = true;
      } else {
        document.getElementById("btnRegister").disabled = true;
        document.getElementById("btnRegister").innerText = "å·²æˆç‚ºæœƒå“¡";
        document.getElementById("btnRent").disabled = false; // å…ˆæ‰“é–‹ï¼Œå¾Œé¢å†ä¾è»Šæ³åˆ¤æ–·
      }

      // 3. æª¢æŸ¥å–®è»Š (ID: 1) ç‹€æ…‹
      const [isRented, renter] = await contract.getBikeStatus(1);
      
      const bikeIcon = document.getElementById("bikeIcon");
      const statusText = document.getElementById("btnRent");
      const returnBtn = document.getElementById("btnReturn");

      if (isRented) {
        // å¦‚æœè¢«ç§Ÿèµ°äº†
        if (renter.toLowerCase() === currentAccount.toLowerCase()) {
          // æ˜¯æˆ‘ç§Ÿçš„ -> é¡¯ç¤ºé‚„è»Šéˆ•
          bikeIcon.classList.add("bike-active");
          bikeIcon.innerText = "ğŸš´ğŸ’¨";
          document.getElementById("bikeStatusText").innerText = "ç§Ÿå€Ÿè¨ˆæ™‚ä¸­...";
          document.getElementById("bikeStatusText").style.color = "#2ecc71";
          
          statusText.style.display = "none";
          returnBtn.style.display = "inline-block";
        } else {
          // åˆ¥äººç§Ÿçš„ -> é–å®šæŒ‰éˆ•
          bikeIcon.innerText = "ğŸ”’";
          document.getElementById("bikeStatusText").innerText = "æ­¤è»Šå·²è¢«ä»–äººç§Ÿå€Ÿ";
          statusText.style.display = "inline-block";
          statusText.disabled = true;
          statusText.innerText = "ğŸš« å–®è»Šä½¿ç”¨ä¸­";
          returnBtn.style.display = "none";
        }
      } else {
        // é–’ç½®ä¸­
        bikeIcon.classList.remove("bike-active");
        bikeIcon.innerText = "ğŸš²";
        document.getElementById("bikeStatusText").innerText = "é–’ç½®ä¸­ï¼Œå¯ç§Ÿå€Ÿ";
        document.getElementById("bikeStatusText").style.color = "#8b9bb4";

        returnBtn.style.display = "none";
        statusText.style.display = "inline-block";
        // å¦‚æœå·²è¨»å†Šï¼Œå°±é–‹æ”¾ç§Ÿå€Ÿ
        if (isRegistered) {
            statusText.disabled = false;
            statusText.innerText = "ğŸ”“ ç§Ÿå€Ÿå–®è»Š (0.006 ETH)";
        }
      }

    } catch (e) {
      console.error(e);
      document.getElementById("output").innerText = "âš ï¸ è®€å–åˆç´„ç‹€æ…‹å¤±æ•— (è«‹æª¢æŸ¥åˆç´„åœ°å€)";
    }
  }

  // =============================
  // 5. äº¤æ˜“åŠŸèƒ½ (Actions)
  // =============================
  
  // è¨»å†Š
  async function registerUser() {
    try {
      showLoading("äº¤æ˜“ç¢ºèªä¸­ï¼Œè«‹åœ¨éŒ¢åŒ…ç°½å...");
      const tx = await contract.registerUser();
      showLoading("â³ è¨»å†Šä¸Šéˆä¸­...");
      await tx.wait();
      showLoading("");
      alert("ğŸ‰ è¨»å†ŠæˆåŠŸï¼");
      refreshData();
    } catch (e) {
      console.error(e);
      showLoading("âŒ äº¤æ˜“å–æ¶ˆæˆ–å¤±æ•—");
    }
  }

  // ç§Ÿè»Š
  async function rentBike() {
    try {
      showLoading("æº–å‚™æ”¯ä»˜ç§Ÿé‡‘èˆ‡æŠ¼é‡‘...");
      // 0.006 ETH = 0.001 ç§Ÿé‡‘ + 0.005 æŠ¼é‡‘
      const price = ethers.utils.parseEther("0.006"); 
      const tx = await contract.rentBike(1, { value: price });
      
      showLoading("â³ å€å¡Šç¢ºèªä¸­ (é–‹é–æŒ‡ä»¤)...");
      await tx.wait();
      
      showLoading("");
      refreshData(); // é‡æ–°æ•´ç†ä»‹é¢
    } catch (e) {
      console.error(e);
      showLoading("âŒ ç§Ÿå€Ÿå¤±æ•—");
    }
  }

  // é‚„è»Š
  async function returnBike() {
    try {
      showLoading("æ­£åœ¨çµç®—ä¸¦é€€é‚„æŠ¼é‡‘...");
      const tx = await contract.returnBike(1);
      
      showLoading("â³ ç­‰å¾…æŠ¼é‡‘é€€å›...");
      await tx.wait();
      
      showLoading("");
      alert("âœ… é‚„è»ŠæˆåŠŸï¼æŠ¼é‡‘ 0.005 ETH å·²é€€å›æ‚¨çš„éŒ¢åŒ…ã€‚");
      refreshData();
    } catch (e) {
      console.error(e);
      showLoading("âŒ é‚„è»Šå¤±æ•—");
    }
  }

  function showLoading(msg) {
    document.getElementById("output").innerText = msg;
  }

</script>
</body>
</html>